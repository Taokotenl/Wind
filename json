--[[
    Rayfield to WindUI Adapter - Advanced Edition
    Chuyển đổi tự động các lệnh Rayfield sang WindUI với hỗ trợ chỉnh sửa UI
    Sử dụng: local Rayfield = loadstring(game:HttpGet('YOUR_SCRIPT_URL'))()
]]

-- Load WindUI
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

-- Chuyển JSON string sang Lua table
local function ParseJSON(jsonString)
    local parsed = {}
    local success, result = pcall(function()
        return game:GetService("HttpService"):JSONDecode(jsonString)
    end)
    if success then
        return result
    end
    return nil
end

-- Chuyển Lua table sang JSON string
local function ToJSON(table)
    local success, result = pcall(function()
        return game:GetService("HttpService"):JSONEncode(table)
    end)
    if success then
        return result
    end
    return nil
end

-- Tạo Rayfield Adapter
local RayfieldAdapter = {}
RayfieldAdapter.Flags = {}
RayfieldAdapter.UIStructure = {}
RayfieldAdapter.ElementRegistry = {}

-- Hàm chuyển đổi Icon từ Roblox ID sang Lucide
local function ConvertIcon(icon)
    if type(icon) == "number" or (type(icon) == "string" and icon:match("^%d+$")) then
        return "circle"
    end
    return icon or "circle"
end

-- Hàm chuyển đổi Theme
local ThemeMapping = {
    ["Default"] = "Dark",
    ["AmberGlow"] = "Dark",
    ["Amethyst"] = "Dark",
    ["Bloom"] = "Dark",
    ["DarkBlue"] = "Dark",
    ["Green"] = "Dark",
    ["Light"] = "Light",
    ["Ocean"] = "Dark",
    ["Serenity"] = "Dark",
}

-- Xuất cấu trúc UI ra clipboard
function RayfieldAdapter:ExportStructure()
    local json = ToJSON(self.UIStructure)
    if json then
        setclipboard(json)
        return json
    end
    return nil
end

-- Nhập cấu trúc UI từ JSON
function RayfieldAdapter:ImportStructure(jsonString)
    local structure = ParseJSON(jsonString)
    if structure then
        self.UIStructure = structure
        return true
    end
    return false
end

-- CreateWindow
function RayfieldAdapter:CreateWindow(config)
    local WindowAdapter = {}
    
    local windowTitle = config.Name or "Window"
    if windowTitle:find("Flash Hub") then
        windowTitle = windowTitle:gsub("Flash Hub", "VTriP")
    end
    
    local windConfig = {
        Title = windowTitle,
        Icon = ConvertIcon(config.Icon),
        Author = "Host By VTriP Official",
        Folder = (config.ConfigurationSaving and config.ConfigurationSaving.FolderName) or "RayfieldAdapter",
        Size = UDim2.fromOffset(580, 460),
        Transparent = true,
        Theme = ThemeMapping[config.Theme] or "Dark",
        Resizable = true,
        SideBarWidth = 200,
    }
    
    if config.KeySystem then
        windConfig.KeySystem = {
            Key = config.KeySettings.Key or {},
            Note = config.KeySettings.Note or "No key note",
            SaveKey = config.KeySettings.SaveKey or false,
        }
    end
    
    local Window = WindUI:CreateWindow(windConfig)
    
    Window:EditOpenButton({
        Title = "Open VTriP",
        Icon = ConvertIcon(config.Icon),
        CornerRadius = UDim.new(0, 16),
        StrokeThickness = 2,
        Color = ColorSequence.new(
            Color3.fromHex("FF0F7B"),
            Color3.fromHex("F89B29")
        ),
        OnlyMobile = false,
        Enabled = true,
        Draggable = true,
    })
    
    WindowAdapter._windWindow = Window
    WindowAdapter._config = config
    WindowAdapter._tabs = {}
    WindowAdapter._configFile = (config.ConfigurationSaving and config.ConfigurationSaving.FileName) or "Config"
    WindowAdapter._windowId = windowTitle
    
    if config.ToggleUIKeybind then
        local keyCode = config.ToggleUIKeybind
        if type(keyCode) == "string" then
            Window:SetToggleKey(Enum.KeyCode[keyCode])
        else
            Window:SetToggleKey(keyCode)
        end
    end
    
    -- Khởi tạo cấu trúc UI
    if not RayfieldAdapter.UIStructure[WindowAdapter._windowId] then
        RayfieldAdapter.UIStructure[WindowAdapter._windowId] = {
            tabs = {}
        }
    end
    
    -- CreateTab
    function WindowAdapter:CreateTab(name, icon)
        local TabAdapter = {}
        local tabId = name
        
        if not RayfieldAdapter.UIStructure[WindowAdapter._windowId].tabs[tabId] then
            RayfieldAdapter.UIStructure[WindowAdapter._windowId].tabs[tabId] = {
                name = name,
                icon = icon,
                elements = {}
            }
        end
        
        local Tab = Window:Tab({
            Title = name,
            Icon = ConvertIcon(icon),
        })
        
        TabAdapter._windTab = Tab
        TabAdapter._tabId = tabId
        TabAdapter._windowId = WindowAdapter._windowId
        TabAdapter._elements = {}
        
        -- CreateSection
        function TabAdapter:CreateSection(name)
            local SectionAdapter = {}
            
            local Section = Tab:Section({
                Title = name,
                Box = true,
                Opened = true,
            })
            
            SectionAdapter._windSection = Section
            SectionAdapter._name = name
            
            function SectionAdapter:Set(newName)
                Section:SetTitle(newName)
                SectionAdapter._name = newName
            end
            
            return SectionAdapter
        end
        
        -- CreateDivider
        function TabAdapter:CreateDivider()
            local DividerAdapter = {}
            
            local Section = Tab:Section({
                Title = "───────────────────",
                Box = false,
                Opened = true,
            })
            
            function DividerAdapter:Set(visible)
                if visible then
                    Section:SetTitle("───────────────────")
                else
                    Section:SetTitle("")
                end
            end
            
            return DividerAdapter
        end
        
        -- CreateButton
        function TabAdapter:CreateButton(config)
            local ButtonAdapter = {}
            local elementId = config.Name
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "Button",
                name = config.Name,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local Button = Tab:Button({
                Title = config.Name,
                Desc = config.Desc or "",
                Callback = config.Callback or function() end
            })
            
            ButtonAdapter._windButton = Button
            ButtonAdapter._elementId = elementId
            
            function ButtonAdapter:Set(newName)
                Button:SetTitle(newName)
                ButtonAdapter._elementId = newName
                RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[newName] = 
                    RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId]
                RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = nil
            end
            
            return ButtonAdapter
        end
        
        -- CreateToggle
        function TabAdapter:CreateToggle(config)
            local ToggleAdapter = {}
            local elementId = config.Name
            ToggleAdapter.CurrentValue = config.CurrentValue or false
            
            local description = config.Desc or ""
            if config.Plus then
                description = "[Plus Feature] " .. description
            end
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "Toggle",
                name = config.Name,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local Toggle = Tab:Toggle({
                Title = config.Name,
                Desc = description,
                Type = "Checkbox",
                Value = config.CurrentValue or false,
                Callback = function(state)
                    ToggleAdapter.CurrentValue = state
                    if config.Callback then
                        config.Callback(state)
                    end
                end
            })
            
            ToggleAdapter._windToggle = Toggle
            ToggleAdapter._elementId = elementId
            
            if config.Flag then
                RayfieldAdapter.Flags[config.Flag] = ToggleAdapter
            end
            
            function ToggleAdapter:Set(value)
                self.CurrentValue = value
                Toggle:Set(value)
            end
            
            return ToggleAdapter
        end
        
        -- CreateSlider
        function TabAdapter:CreateSlider(config)
            local SliderAdapter = {}
            local elementId = config.Name
            SliderAdapter.CurrentValue = config.CurrentValue or config.Range[1]
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "Slider",
                name = config.Name,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local Slider = Tab:Slider({
                Title = config.Name,
                Desc = config.Suffix or "",
                Step = config.Increment or 1,
                Value = {
                    Min = config.Range[1],
                    Max = config.Range[2],
                    Default = config.CurrentValue or config.Range[1],
                },
                Callback = function(value)
                    SliderAdapter.CurrentValue = value
                    if config.Callback then
                        config.Callback(value)
                    end
                end
            })
            
            SliderAdapter._windSlider = Slider
            SliderAdapter._elementId = elementId
            
            if config.Flag then
                RayfieldAdapter.Flags[config.Flag] = SliderAdapter
            end
            
            function SliderAdapter:Set(value)
                self.CurrentValue = value
                Slider:Set(value)
            end
            
            return SliderAdapter
        end
        
        -- CreateInput
        function TabAdapter:CreateInput(config)
            local InputAdapter = {}
            local elementId = config.Name
            InputAdapter.CurrentValue = config.CurrentValue or ""
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "Input",
                name = config.Name,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local Input = Tab:Input({
                Title = config.Name,
                Desc = "",
                Value = config.CurrentValue or "",
                Type = "Input",
                Placeholder = config.PlaceholderText or "",
                Callback = function(text)
                    InputAdapter.CurrentValue = text
                    if config.Callback then
                        config.Callback(text)
                    end
                end
            })
            
            InputAdapter._windInput = Input
            InputAdapter._elementId = elementId
            
            if config.Flag then
                RayfieldAdapter.Flags[config.Flag] = InputAdapter
            end
            
            function InputAdapter:Set(value)
                self.CurrentValue = value
                Input:Set(value)
            end
            
            return InputAdapter
        end
        
        -- CreateDropdown
        function TabAdapter:CreateDropdown(config)
            local DropdownAdapter = {}
            local elementId = config.Name
            DropdownAdapter.CurrentOption = config.CurrentOption or {}
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "Dropdown",
                name = config.Name,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local Dropdown = Tab:Dropdown({
                Title = config.Name,
                Desc = "",
                Values = config.Options or {},
                Value = config.CurrentOption or {},
                Multi = config.MultipleOptions or false,
                AllowNone = true,
                Callback = function(options)
                    DropdownAdapter.CurrentOption = options
                    if config.Callback then
                        config.Callback(options)
                    end
                end
            })
            
            DropdownAdapter._windDropdown = Dropdown
            DropdownAdapter._elementId = elementId
            
            if config.Flag then
                RayfieldAdapter.Flags[config.Flag] = DropdownAdapter
            end
            
            function DropdownAdapter:Set(options)
                self.CurrentOption = options
                Dropdown:Select(options)
            end
            
            function DropdownAdapter:Refresh(newOptions)
                Dropdown:Refresh(newOptions)
            end
            
            return DropdownAdapter
        end
        
        -- CreateColorPicker
        function TabAdapter:CreateColorPicker(config)
            local ColorPickerAdapter = {}
            local elementId = config.Name
            ColorPickerAdapter.CurrentValue = config.Color or Color3.fromRGB(255, 255, 255)
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "ColorPicker",
                name = config.Name,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local ColorPicker = Tab:Colorpicker({
                Title = config.Name,
                Desc = "",
                Default = config.Color or Color3.fromRGB(255, 255, 255),
                Transparency = 0,
                Callback = function(color)
                    ColorPickerAdapter.CurrentValue = color
                    if config.Callback then
                        config.Callback(color)
                    end
                end
            })
            
            ColorPickerAdapter._windColorPicker = ColorPicker
            ColorPickerAdapter._elementId = elementId
            
            if config.Flag then
                RayfieldAdapter.Flags[config.Flag] = ColorPickerAdapter
            end
            
            function ColorPickerAdapter:Set(color)
                self.CurrentValue = color
            end
            
            return ColorPickerAdapter
        end
        
        -- CreateKeybind
        function TabAdapter:CreateKeybind(config)
            local KeybindAdapter = {}
            local elementId = config.Name
            KeybindAdapter.CurrentKeybind = config.CurrentKeybind or "None"
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "Keybind",
                name = config.Name,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local Keybind = Tab:Keybind({
                Title = config.Name,
                Desc = "",
                Value = config.CurrentKeybind or "None",
                Callback = function(key)
                    KeybindAdapter.CurrentKeybind = key
                    if config.Callback then
                        if config.HoldToInteract then
                            config.Callback(true)
                        else
                            config.Callback(key)
                        end
                    end
                end
            })
            
            KeybindAdapter._windKeybind = Keybind
            KeybindAdapter._elementId = elementId
            
            if config.Flag then
                RayfieldAdapter.Flags[config.Flag] = KeybindAdapter
            end
            
            function KeybindAdapter:Set(key)
                self.CurrentKeybind = key
            end
            
            return KeybindAdapter
        end
        
        -- CreateLabel
        function TabAdapter:CreateLabel(title, icon, color, ignoreTheme)
            local LabelAdapter = {}
            local elementId = title
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "Label",
                name = title,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local Label = Tab:Paragraph({
                Title = title,
                Desc = "",
                Image = "",
                Locked = false,
            })
            
            LabelAdapter._windLabel = Label
            LabelAdapter._elementId = elementId
            
            function LabelAdapter:Set(newTitle, newIcon, newColor, newIgnoreTheme)
                Label:SetTitle(newTitle)
                LabelAdapter._elementId = newTitle
            end
            
            return LabelAdapter
        end
        
        -- CreateParagraph
        function TabAdapter:CreateParagraph(config)
            local ParagraphAdapter = {}
            local elementId = config.Title
            
            RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements[elementId] = {
                type = "Paragraph",
                name = config.Title,
                enabled = true,
                order = #RayfieldAdapter.UIStructure[TabAdapter._windowId].tabs[TabAdapter._tabId].elements + 1
            }
            
            local Paragraph = Tab:Paragraph({
                Title = config.Title or "Paragraph",
                Desc = config.Content or "",
                Locked = false,
            })
            
            ParagraphAdapter._windParagraph = Paragraph
            ParagraphAdapter._elementId = elementId
            
            function ParagraphAdapter:Set(newConfig)
                Paragraph:SetTitle(newConfig.Title or config.Title)
                Paragraph:SetDesc(newConfig.Content or config.Content)
            end
            
            return ParagraphAdapter
        end
        
        return TabAdapter
    end
    
    -- ModifyTheme
    function WindowAdapter.ModifyTheme(theme)
        if type(theme) == "string" then
            WindUI:SetTheme(ThemeMapping[theme] or theme)
        else
            WindUI:AddTheme(theme)
        end
    end
    
    -- SetVisibility
    function WindowAdapter:SetVisibility(visible)
    end
    
    -- IsVisible
    function WindowAdapter:IsVisible()
        return true
    end
    
    -- Destroy
    function WindowAdapter:Destroy()
        if self._windWindow then
        end
    end
    
    return WindowAdapter
end

-- Notify
function RayfieldAdapter:Notify(config)
    WindUI:Notify({
        Title = config.Title or "Notification",
        Content = config.Content or "",
        Duration = config.Duration or 5,
        Icon = ConvertIcon(config.Image),
    })
end

-- LoadConfiguration
function RayfieldAdapter:LoadConfiguration()
end

-- SetVisibility
function RayfieldAdapter:SetVisibility(visible)
end

-- IsVisible
function RayfieldAdapter:IsVisible()
    return true
end

-- Destroy
function RayfieldAdapter:Destroy()
end

return RayfieldAdapter
